#!/bin/bash

usage()
{
    echo "generate README.md" >&2
    exit 1
}

[[ "$1" == "-h" ]] && usage

readme()
{
    _d=$1
    (
    cd $_d
    for f in *
    do
        [[ -f $f && -x $f && $(basename $f .awk) == $f ]] || continue
        echo "$f" >&2
        if [[ $(basename $f .py) != $f ]]
        then
            usage=$(python ./$f -h 2>&1 | dos2unix)
        else
            usage=$(./$f -h 2>&1)
        fi
        [[ -n "$usage" ]] && ! grep -q 'bad interpreter' <<< "$usage" && {
            echo "<h2>$_d/$f</h2>"
            while read line
            do
                line=$(sed 's/</\&lt;/g; s/>/\&gt;/g' <<< "$line")
                echo "$line<br>"
            done <<< "$usage"
            echo 
        }
    done
    )
}

readme_all()
{
    echo "<h1>USER GUIDE FOR SCRIPTS</h1>"
    echo "(Note: This document is generated by common/genreadme)<br>"
    echo
    for subdir in *
    do
        [[ -d $subdir ]] || continue
        case "$subdir" in
            "codesummary" |\
            "thirdparty"  |\
            "stack"       |\
            "gdb"         |\
            "gcc" ) continue;;
            *) readme $subdir;;
        esac
    done
}

# uniform the locale to ensure same sort order of files(refer to sort manual)
LC_ALL=C
cd $(dirname $0)/..
readme_all > README.md
